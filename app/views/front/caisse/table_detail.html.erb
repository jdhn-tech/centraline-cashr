<div id="table_detail" class="content">
	<div class="col-xs-8 col-xs-offset-2  content_Table_Detail">
		<table id='Table_Detail' class='table table-scroll table-striped'>
			<thead>
				<tr>
					<th colspan="2" rowspan="2">
						<div><img src="/assets/table1.png" onclick="toggleTableDetail()"></div>
						<div><button class="btn" onclick="addCodeManually()"><span class='glyphicon glyphicon-hand-up'></span></button></div> </th>
					<th colspan="5">Ref : <%=@note.reference%><br>N° Table : <%=@table.table_number.to_s.rjust(2,'0')%></th>
				</tr>
				<tr>
					<th style="width:10%">Code</th>
					<th style="width:10%">Nom</th>
					<th style="width:10%">Prix Unité</th>
					<th style="width:45%">Note</th>
					<th style="width:10%">Etat</th>
				</tr>
			</thead>
			
			<tbody id='table_detail_note'>
				<%# @note.getMenus.each do |menu| %>
					<!--<tr>
						<td>
							<button type='button' class='btn btn-default btn-lg' onClick='duplicateLineNote(this)'><span class='glyphicon glyphicon-duplicate' aria-hidden='true'></span></button>
						</td>
						<td>
							<button type='button' class='btn btn-default btn-lg' onClick='removeLineNote(this)'><span class='glyphicon glyphicon-trash' aria-hidden='true'></span></button>
						</td>
						<td class='table_note_code'><%#=menu.code%></td>
						<td><%#=menu.name%></td>
						<td class='table_note_price'><%#=menu.price.to_f / 100%> €</td>
						<td>
							<button type='button' class='btn btn-default btn-lg' onClick='addNotice(this)'><span class='glyphicon glyphicon glyphicon-plus' aria-hidden='true'></span></button>
						</td>
						<td></td>
					</tr>
				<%# end %>
				<%# @note.getArticles.each do |article| %>
					<tr>
						<td>
							<button type='button' class='btn btn-default btn-lg' onClick='duplicateLineNote(this)'><span class='glyphicon glyphicon-duplicate' aria-hidden='true'></span></button>
						</td>
						<td>
							<button type='button' class='btn btn-default btn-lg' onClick='removeLineNote(this)'><span class='glyphicon glyphicon-trash' aria-hidden='true'></span></button>
						</td>
						<td class='table_note_code'><%#=article.code%></td>
						<td><%#=article.name%></td>
						<td class='table_note_price'><%#=article.price.to_f / 100%> €</td>
						<td>
							<button type='button' class='btn btn-default btn-lg' onClick='addNotice(this)'><span class='glyphicon glyphicon glyphicon-plus' aria-hidden='true'></span></button>
						</td>
						<td></td>
					</tr>-->
				<%# end %>
				<% @note.note_entries.each do |entry| %>
					<tr id="entry<%=entry.id%>">
						<td>
							<button type='button' class='btn btn-default btn-lg' onClick='duplicateLineNote(this, <%=entry.id%>)'><span class='glyphicon glyphicon-duplicate' aria-hidden='true'></span></button>
						</td>
						<td>
							<button type='button' class='btn btn-default btn-lg' onClick='removeLineNote(this, <%=entry.id%>)'><span class='glyphicon glyphicon-trash'></span></button>
						</td>
						<td class='table_note_code'><%=entry.getCode%></td>
						<td><%=entry.getName%></td>
						<td class='table_note_price'><%=entry.value.to_f / 100%> €</td>
						<td>
							<button type='button' class='btn btn-default btn-lg' onClick='addNotice(this, <%=entry.id%>)'><span class='glyphicon glyphicon glyphicon-plus'></span></button>
						</td>
						<td><%=entry.status%></td>
					</tr>
				<% end %>
			</tbody>
			<tfoot>
				<tr>
					<th colspan="7" id="table_note_sum">Somme = <%=@note.getTotal.to_f / 100%> €</th>
				</tr>
			</tfoot>
		</table>
	</div>
	<table id='Table_Bottom' class='Table_Bottom'>
		<tr style="height:50px;">
			<td><a class="btn" href="/front/edition_liste/<%=@note.id%>">Edition liste</a></td>
			<td><a class="btn" href="/front/edition_client">Edition Client</a></td>
			<td><a class="btn" href="/front/encaisser/<%=@note.id%>">Encaisser</a></td>
			<td><a class="btn" href="/front/annulation/<%=@table.id%>">Annulation</a></td>
		</tr>
	</table>	
</div>

<%= render "table_book" %>
<%= render "keyboard" %>
<%= render "keyboard_notice" %>

<script >
function updateNote(){
	var items = ($(".table_note_code").map(function(){return $(this).text();}).get()).join(";");
	
	$.ajax({
		async: false,
		url: "/front/notes/update/<%=@note.id%>?articles="+escape(items),
		type: "GET",
		success : function(data) {

		},
		error : function(data) {

		}
	})
}
function toggleTableDetail() {
	if ($("#table_detail").is(":visible")) {
		$("#table_detail").hide();
		$("#table_book").show();
	} else {
		$("#table_detail").show();
		$("#table_book").hide();
	}
}
function duplicateLineNote(e, entry_id) {
	var thisLine = $(e).parent().parent();
	console.log(thisLine);
	$.ajax({
		async: false,
		url: "/front/notes/<%=@note.id%>/clone_entry/"+entry_id,
		type: "GET",
		success : function(data) {
			$("#table_detail_note").append(thisLine.clone());
			updateSum();
		}
	})
}
function removeLineNote(e, entry_id) {
	$.ajax({
		async: false,
		url: "/front/notes/<%=@note.id%>/remove_entry/"+entry_id,
		type: "GET",
		success : function(data) {
			$(e).parent().parent().remove();
			updateSum();
		}
	})
}
function updateSum() {
	var sum = 0;
	$(".table_note_price").each(function(i,obj) {
		sum += parseFloat($(obj).text());
	});
	$("#table_note_sum").text("Somme = "+sum+" €");
}
function addCodeManually(){
	$('#modalAddCodeManually').modal('show');
}
function addNotice(e) {
	var rowIndex = $(e).closest('tr').index();
	$('#modalAddNotice #hide_tableIndex').val(rowIndex);
	$("#modalAddNotice").modal("show");
}

</script>